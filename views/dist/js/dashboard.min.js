angular.module("RDash", ["ui.bootstrap", "ui.router", "ngCookies"]) /*,angular.module("app",["ui.bootstrap","ui.router","ngCookies"])*/ ;
"use strict";
angular.module('RDash').service('EventHandler', function errorHandler($location) {
    var errorListeners = [];
    this.error = function(res) {
        var error, status;
        console.log("ERROR", res);
        if(res.status){
            error = res.data;
            status = res.status;
            if (status === 401) {
                $location.url('/');
            }
            var req = res.config;
            console.log("HTTP Error: " + status + "  " + req.method + " " + req.url, error.message);
        } else {
            error = res;
            console.log("APP Error: ", error.message);
        }
        for (var i = errorListeners.length - 1; i >= 0; i--) {
            errorListeners[i](error, status);
        }
    };
    this.addErrorListener = function(callback) {
        errorListeners.push(callback);
    };
});


angular.module('RDash').service('Http', function httpService($location, $http, EventHandler) {
    var errorListeners = [];
    /**
     * Url del servidor
     * @type {string}
     */
    this.serverUrl = $location.protocol() + '://'+ $location.host() + ':' + '3000/api/';
    //this.serverUrl = '/api/';
    /**
     * Método encargado de hacer peticiones HTTP Post
     * @param relativRoute Ruta relativa a donde realizar la petición
     * @param body Objeto a mandar en la petición HTTP
     * @returns {*}
     */
    this.post = function(relativRoute, body) {
        var url = "POST " + this.serverUrl + relativRoute;
        dev(url);
        return $http.post(this.serverUrl + relativRoute, body, {
            withCredentials: true
        }).then(function(res) {
            return res.data;
        }, EventHandler.error);
    };
    /**
     * Método encargado de realizar peticiones HTTP Get
     * @param relativRoute Ruta a donde se realizará la petición Get
     * @returns {*}
     */
    this.get = function(relativRoute) {
        var url = "GET " + this.serverUrl + relativRoute;
        dev(url);
        return $http.get(this.serverUrl + relativRoute, {
            withCredentials: true
        }).then(function(res) {
            return res.data;
        }, EventHandler.error);
    };
    /**
     * Método encargado de realizar peticiones HTTP Delete
     * @param relativRoute Ruta a donde se realizará la petición Delete
     * @returns {*}
     */
    this.delete = function(relativRoute) {
        var url = "DELETE " + this.serverUrl + relativRoute;
        dev(url);
        return $http.delete(this.serverUrl + relativRoute, {
            withCredentials: true
        }).then(function(res) {
            return res.data;
        }, EventHandler.error);
    };
    /**
     * Método que hace logs en la consola JavaScript
     * @param message El mensaje a mostrar en la consola
     */
    function dev(message) {
        console.log("HTTP:" + message);
    }
});


angular.module('RDash').service('Proyecto', function($rootScope, Http, EventHandler) {
    console.log('JLPO_CREACION_SERVICIO');
    self = this;

    self.getAll = function() {
        return Http.get('proyectos');
    };

    self.get = function(proyectoId) {
        return Http.get('proyectos/' + proyectoId);
    };

    self.save = function(proyecto) {
        return Http.post('proyectos/', proyecto);
    };

    self.delete = function(proyectoId) {
        return Http.delete('proyectos/'+ proyectoId);
    };

    self.getSubproyectos = function(proyectoId){
        return Http.get('proyectos/'+proyectoId+'/subproyectos');
    };

});

angular.module('RDash').service('Subroyecto', function($rootScope, Http, EventHandler) {
    console.log('JLPO_CREACION_SERVICIO_Subroyecto');
    self = this;

    self.getAll = function() {
        return Http.get('proyectos');
    };

    self.get = function(proyectoId) {
        return Http.get('proyectos/' + proyectoId);
    };

    self.save = function(proyecto) {
        return Http.post('proyectos/', proyecto);
    };

    self.delete = function(proyectoId) {
        return Http.delete('proyectos/'+ proyectoId);
    };

    self.getTareas = function(subproyectoId){
        return Http.get('subproyectos/'+subproyectoId+'/tareas');
    };


});


angular.module("RDash").config(["$stateProvider", "$urlRouterProvider", function(t, e) {
    e.otherwise("/"), t.state("index", {
        url: "/",
        templateUrl: "templates/dashboard.html"
    }).state("tables", {
        url: "/tables",
        templateUrl: "templates/tables.html"
    }).state("proyectos", {
        url: "/proyectos",
        templateUrl: "../app/proyectos/proyectos.html"
    }).state("editProyecto", {
        url: "/proyectos/edit",
        templateUrl: "../app/proyectos/editProyecto.html"
    }).state("editSubproyecto", {
        url: "/subproyectos/edit",
        templateUrl: "../app/subproyectos/editSubroyecto.html"
    })
}]);

function AlertsCtrl(e) {
    e.alerts = [{
        type: "success",
        msg: "Gracias por su visita!"
    }, {
        type: "danger",
        msg: "Se ha detectado una inconsistencia."
    }], e.addAlert = function() {
        e.alerts.push({
            msg: "Otra alerta!"
        })
    }, e.closeAlert = function(t) {
        e.alerts.splice(t, 1)
    }
}
angular.module("RDash").controller("AlertsCtrl", ["$scope", AlertsCtrl]);

function MasterCtrl(t,e){
    var g = 992;
    t.getWidth = function(){
        return window.innerWidth
    }, t.$watch(t.getWidth, function(o, n){
        o >= g ? angular.isDefined(e.get("toggle")) ? t.toggle = !!e.get("toggle") : t.toggle = !0 : t.toggle = !1
    }), t.toggleSidebar = function(){
        t.toggle = !t.toggle,e.put("toggle", t.toggle)
    }, window.onresize = function(){
        t.$apply()
    }
}


angular.module("RDash").controller("MasterCtrl", ["$scope", "$cookieStore", MasterCtrl]);

var idProyectoActual = 1;
var idProyActual;
var idSubProyActual;

angular.module("RDash").controller('ProyectosCtrl', function($scope, /*$mdDialog,*/ /*$mdEditDialog,*/ $location, Proyecto) {
    console.log('JLPO_CREACION_CONTROLADOR');
    console.log('idProyectoActual= '+idProyectoActual);
    $scope.selected = [];

    refresh();

    function refresh() {
        console.log('Entro JLPO');
        Proyecto.getAll().then(function(proyectos) {
            $scope.proyectos = proyectos;
        });
    }


    $scope.select = function(proyecto) {
        $scope.proyectoSelected = proyecto;
    };

    $scope.editProyecto = function(proyecto) {
        idProyActual = proyecto;
        idProyectoActual = proyecto.id;
    };

    $scope.addProyecto = function() {
        idProyActual = null;
        idProyectoActual = 0;
    };

    $scope.delProyecto = function(ev, proyecto) {
        /*var confirm = $mdDialog.confirm()
            .title('¿Esta seguro que quiere eliminar el proyecto?')
            .textContent('Una vez sea eliminado no podra ser recuperado.')
            .ariaLabel('Eliminacion de proyectos')
            .targetEvent(ev)
            .ok('Confirmar')
            .cancel('Cancelar');
        $mdDialog.show(confirm).then(function() {
            Proyecto.delete(proyecto.id).then(function(){
                Proyecto.getAll().then(function(proyectos) {
                    $scope.proyectos = proyectos;
                });
            });
        }, function() {

        });*/

        Proyecto.delete(proyecto.id).then(function(){
            Proyecto.getAll().then(function(proyectos) {
                $scope.proyectos = proyectos;
            });
        });

    };


    $scope.getProyectos = function() {
        $scope.promise = Proyecto.getAll().$promise;
    };

    $scope.getProyecto = function() {
//        console.log('IdProyecto get : '+$scope.id);
//        $scope.promise = Proyecto.getAll().$promise;
    };


    $scope.query = {
        order: 'nombre',
        limit: 10,
        page: 1
    };

});

angular.module("RDash").controller('editProyectosCtrl', function($scope, /*$mdDialog, $mdEditDialog,*/ $location, Proyecto) {
    console.log('JLPO_CREACION_CONTROLADOR_EDIT');
    $scope.selected = [];

    refresh();

    function refresh() {
        $scope.proyecto =idProyActual;
        if (idProyActual){
            Proyecto.getSubproyectos(idProyActual.id).then(function(subproyectos) {
                $scope.subproyectos = subproyectos;
            });
        }
        console.log('Entro JLPO2');
        console.log('IdProyecto get : '+$scope.params);
        console.log('idProyectoActual= '+idProyectoActual);

    }

    $scope.guardarProyecto = function() {
        var estadpPry = $scope.proyecto.estado;
        console.log('estadpPry='+estadpPry);
        if ($scope.proyecto.id <= 0){
            estadpPry='N';
        }
        var proyectoTmp = {
            id: $scope.proyecto.id,
            nombre: $scope.proyecto.nombre,
            descripcion: $scope.proyecto.descripcion,
            estado: estadpPry
        };
        $scope.promise = Proyecto.save(proyectoTmp).then(function(){
            $location.path('/proyectos');
        }).$promise;
        //console.log('nombre  '+idProyActual.nombre);
        //console.log('nombre  '+$scope.proyecto.nombre);
    };

    $scope.cancel = function(){

        $location.path('/proyectos');
    }

    $scope.editSubroyecto = function(subproyecto){
        idSubProyActual = subproyecto;
        console.log('Subproyecto:'+idSubProyActual.id);
        $location.path('/subproyectos/edit');
    }


});

angular.module("RDash").controller('editSubproyectosCtrl', function($scope, /*$mdDialog, $mdEditDialog,*/ $location, Proyecto, Subroyecto) {
    console.log('JLPO_CREACION_CONTROLADOR_EDIT_SB');
    $scope.selected = [];

    refreshSb();

    function refreshSb() {
        $scope.subproyecto = idSubProyActual;
        if (idSubProyActual){
            Subroyecto.getTareas(idSubProyActual.id).then(function(tareas) {
                $scope.tareas = tareas;
            });
        }
        console.log('Entro JLPO2');
        //console.log('IdSubProyecto get : '+idSubProyActual.id);
        console.log('idProyectoActual= '+idSubProyActual);

    }

    $scope.guardarProyecto = function() {
        var estadpPry = $scope.proyecto.estado;
        console.log('estadpPry='+estadpPry);
        if ($scope.proyecto.id <= 0){
            estadpPry='N';
        }
        var proyectoTmp = {
            id: $scope.proyecto.id,
            nombre: $scope.proyecto.nombre,
            descripcion: $scope.proyecto.descripcion,
            estado: estadpPry
        };
        $scope.promise = Proyecto.save(proyectoTmp).then(function(){
            $location.path('/proyectos');
        }).$promise;
        //console.log('nombre  '+idProyActual.nombre);
        //console.log('nombre  '+$scope.proyecto.nombre);
    };

    $scope.cancel = function(){
        $location.path('/proyectos');
    }

});


function rdLoading(){
    var d = {
        restrict: "AE",
        template: '<div class="loading"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>'
    };
    return d
}
angular.module("RDash").directive("rdLoading", rdLoading);

function rdWidgetBody(){
    var d = {
        requires: "^rdWidget",
        scope: {
            loading: "=?",
            classes: "@?"
        },
        transclude: !0,
        template: '<div class="widget-body" ng-class="classes"><rd-loading ng-show="loading"></rd-loading><div ng-hide="loading" class="widget-content" ng-transclude></div></div>',
        restrict: "E"
    };
    return d
}
angular.module("RDash").directive("rdWidgetBody", rdWidgetBody);

function rdWidgetFooter(){
    var e = {
        requires: "^rdWidget",
        transclude: !0,
        template: '<div class="widget-footer" ng-transclude></div>',
        restrict: "E"
    };
    return e
}
angular.module("RDash").directive("rdWidgetFooter", rdWidgetFooter);

function rdWidgetTitle(){
    var i = {
        requires: "^rdWidget",
        scope: {
            title: "@",
            icon: "@"
        },
        transclude: !0,
        template: '<div class="widget-header"><div class="row"><div class="pull-left"><i class="fa" ng-class="icon"></i> {{title}} </div><div class="pull-right col-xs-6 col-sm-4" ng-transclude></div></div></div>',
        restrict: "E"
    };
    return i
}
angular.module("RDash").directive("rdWidgetHeader", rdWidgetTitle);

function rdWidget(){
    var d = {
        transclude: !0,
        template: '<div class="widget" ng-transclude></div>',
        restrict: "EA"
    };
    return d
}
angular.module("RDash").directive("rdWidget", rdWidget);
